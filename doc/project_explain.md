# <center>数据仓库工程注意事项</center>


[TOC]

## 概述

&emsp;&emsp; 数据仓库工程主要提供了一个集成的shell环境,以及一些常用的shell命令的封装,使用方式上来说,更多是通过大家约定俗成的方式,来保证工程内部的一致性。为保证相关开发人员能够全部知悉相关约定及注意事项，将相关内容整理如下。



## 工程相关

- 工程目录使用

&emsp;&emsp;数据仓库工程目录采用约定的形式，除了已经定义好的工程目录，子级目录的创建依据以下原则：

1. **bin目录**

   &emsp;&emsp; 主要存放工程中可执行的任务脚本，bin目录下每个子目录代表一个功能模块，如：easylife_dw 代表数据仓库主体模块,每个模块有自己的目录，模块与模块之间区分开。

2. **conf目录**

   ​	配置文件目录主要存放的是环境的配置以及一些系统的配置文件,该目录下的sys.properties 为整个工程的系统配置文件

   ​	如pro/test/pre/dev 代表每个环境的配置目录,主要存放环境相关的配置文件。

3. **env目录**

   ​	该目录下最重要的是common_setting.sh 这个脚本，该脚本是所有脚本的基础，定义了环境相关的所有变量以及方法。

   ​	除了该脚本，还有工程打包及备份脚本ProjectPackage.py, 主要用来对工程进行打包及备份操作

4. **lib目录**

   ​	lib目录主要是用于工程相关的依赖工具等。主要是根据语言不同存放不同的依赖工具。

5. **tools目录**

​	tools目录存放的为工程所有工具脚本，是最核心的目录，在脚本中可以通过$TOOLS_DIR这个变量引用到该目录，并且使用该目录下的工具脚本，这个目录中的工具，如无特殊情况，不允许修改里边的脚本。

- 环境配置

  ​	脚本工程在初始化时，会向当前系统用户的配置文件~/.bash_profile 中添加SCRIPT_HOME变量

  ```shell
  export SCRIPT_HOME=/user/home/easylife/apps/easylife_dw
  ```

  ​	由于涉及到生产环境/开发环境/测试环境/灰度环境的切换等问题，所以在工程中，需要指定当前的运行环境，默认运行环境为dev

  ​	如果需要指定环境，需要修改env/common_setting.sh 中的PROJECT_ENV变量

  ```shell
  $PROJECT_ENV=pro	//pro 生产
  ```

- 配置文件使用

  - 数据库配置文件

    链接mysql时，需要指定mysql的配置文件，在使用时，我们只需要声明目标库的配置文件，脚本会自动根据当前环境选取不同的环境配置文件。不需要额外指定环境目录

    ```properties
    export db_conf_file=easylife_db.properties
    ```

    这里的配置文件变量名称必须为db_conf_file

  - 系统配置文件

    现在系统配置文件sys.properties中，主要配置的是工程打包相关的内容，以及监控报警相关的配置信息，工程级别，系统级别的都可以配置到这个配置文件中

    

## 编码相关

- 脚本编码

  主要有以下一些建议及规范

   1. 脚本编写需要使用工程中提供的模板script_template.sh。

  	2. 在脚本信息中，需要添加 如修改人 修改时间 版本 脚本功能概述等描述信息。

  	3. 脚本必须要在脚本头指定运行解释器 #!/bin/bash。

  	4. 脚本中，sourece $SCRIPT_HOME/env/common_setting.sh 必须要有 并且在最上方。

  	5. 脚本中，每个具体步骤应该用注释虚线分割，并在步骤的开始注释描述清晰。

  	6. 脚本运行时输出日志，应该能够体现任务的关键信息以及时间，可以通过common_setting.sh脚本中定义的方法输出日志。

      ```shell
      logger_info()	//INFO级别日志
      logger_warn()	//WARN级别日志
      logger_err()	//ERROR级别日志
      ```

  	7. 脚本变量命名应该见名知意，避免a/b等命名方式，同时应该注意避免和系统现有环境变量重名等问题

  	8. 脚本编写时，建议注意下编写的代码风格，注意tab和空格的合理使用，保持行与行之间的缩进，有助于提高代码可读性。

  	9. 字符串变量引用时，如果有特殊字符，需要使用“${var}”的方式引用，避免识别到特殊字符导致引用失败

  	10. 变量与变量之间需要有良好的空格习惯，避免造成代码可读性差

  	11. 脚本文件的编码格式为UTF-8 换行符的格式为\n 也就是unix的 LF
---
- SQL编码

  数据仓库开发中，涉及到大量的SQL开发编码，所以针对SQL编码，做如下建议及规范

  - **SQL文件规范**
    1. 建表语句：以表名为文件名，以.cql为后缀
    2. 执行语句：以表名为文件名，以.sql为后缀
    3. 文件编码为UTF-8 换行符为LF
    4. SQL文件需要放到所属模块指定的目录
  - **建表语句**

  	1. 建表语句中，建表语句必须要搭配一个与之向匹配的删除语句，避免自动化建表失败等问题。
  	2. 建表语句中，必须要指定scheam 也就是必须要写成库名.表名的形式
  	3. 建表语句中，字段名称命名采用下划线命名法
  	4. 建表语句中，字段名称后边需要空两个半角空格
  	5. 建表语句中，关键字需要大写，如CREATE TABLE / COMMENT 等
  	6. 建表语句中，表用途注释必须要有，并且要保证含义正确
  	7. 建表语句中，数据类型应该兼容数据的实际类型，避免出现数据隐式转换导致数据改变
  	8. 建表语句中，字段备注必须要保证能够详细的描述该字段的含义，如字段有枚举值，应该明确显示出来
  	9. 建表语句中，列分割字符采用“\u0001” 也就是^a  行分割符采用  "\n"
  	10. 建表语句中，数据格式默认采用text, 可根据具体场景选取其它的数据格式
---
  - **执行语句**

  1. 执行语句中，所有SQL关键字必须要大写

  2. 执行语句中，需要注意编写的SQL的代码风格，select /from /on /where /join 等步骤关键字后边需要换行书写

  3. 执行语句中，源字段名称和目标字段名称不一致时，必须要使用 as 转换字段名称，避免出现歧义

  4. 执行语句中，中间表/临时表/子查询等，必须使用as 关键字显式指定别名

  5. 执行语句中，子查询需要使用括弧圈起来，并且尽量在子查询中对数据进行过滤，减少后续处理的数据量

  6. 执行语句中，在第一行必须要显式书写在那个库执行语句 use xxx_db;

  7. 执行语句中，如果涉及到分区相关的使用，必须要手动指定分区的相关参数设置

     ```sql
     use easylife_ods;
     set hive.exec.dynamic.partition.mode=nonstrict;
     set hive.exec.max.dynamic.partitions.pernode=3650;
     ```

  8. 执行语句中，如果涉及到UDF等相关内容的使用，需要注意手动设置jar包的位置及方法名称等

     ```sql
     USE easylife_dwd;
     add jar /home/hopson/apps/var/hdfs/easylife_dw/lib/java/dc_udf-1.0-SNAPSHOT-jar-with-dependencies.jar;
     create temporary function mergeField as 'com.hopson.dc.udf.field.MergeField';
     ```

  9. 执行语句中，如果涉及到使用脚本外部的参数，需要使用以下这种形式引用

     ```sql
     INSERT OVERWRITE TABLE easylife_ods.ods_broker_company_bak PARTITION(bak_day='${hivevar:yesterday}')   //hivevar：参数名称
     SELECT
     *
     FROM easylife_ods.ods_broker_company;
     ```

  10. 逻辑复杂时，必须要提供整体性的思路注释，以及每个查询字段，子查询等关键节点的单独注释，保证其他人可以通过注释理清逻辑

  11. 必须注意字段名称错误等问题，拼写错误必须注意

  12. 尽量少写select * from xxx 这种问题，select * 会导致下层表结构发生变化后，sql报错的相关问题

  13. 从分区表取数据时，无特殊情况必须要限定分区表的分区区间

  14. 其它应该遵守的SQL规范等。

## 部署相关

- 测试及开发等环境部署相关

  - 测试环境及开发环境部署，无需特殊处理，根据改动大小决定整体部署还是分模块（文件）部署

  - 测试环境及开发环境部署时，需要先拉取最新的develop分支，避免部署后出现缺少代码的相关问题

  - 测试环境及开发环境部署时，部署的分支为当前开发的需求所处的feature分支

  - 测试环境及开发环境部署时，需要将相关改动告知相关人员（测试/开发），避免出现沟通问题

  - 测试环境及开发环境部署时，也需要检查配置文件，避免跨环境脏数据写入等问题

    

- 生产环境部署

   当需求开发完成，测试通过，并且准备上线时，需要做一些相关检查同时有一些注意事项需要注意

  - 上线步骤

    | 编号 | 步骤                                               | 备注                         |
    | ---- | -------------------------------------------------- | ---------------------------- |
    | 1    | 打包前合并feature分支到develop分支，并拉取最新改动 | 上线分支为develop            |
    | 2    | 打包前，检查common_setting.sh中环境配置为pro       | 默认配置为dev                |
    | 3    | 将工程/改动文件等上传服务器                        | 上传到用户目录，避免直接覆盖 |
    | 4    | 备份当前运行工程，执行ProjectPackage.py backup备份 | 备份输出到工程目录xx.bak     |
    | 5    | 确认当前时间无运行中任务，或者任务以暂停           | 通过cdh/resourcemanager      |
    | 6    | 对需要上线的内容进行替换                           | 整体部署的话重新执行init.sh  |
    | 7    | 对上线后工程进行验证，脚本执行，日志输出等         | 通过工程中的测试脚本进行     |

  - 上线注意事项

    1. 检查Hive是否需要添加表/修改表，避免表不存在等问题
    2. 如果涉及到mysql数据表的数据拉取上线，还需要检查mysql的相关表
    3. 如果涉及到mysql问题，需要检查对应mysql配置文件状态，以及连通性测试等
    4. 检查上线涉及到的文件目录是否已创建等问题
    5. 检查上线涉及到的相关组件等大数据环境是否正常（如kafka是否启动/hbase表是否正常等）
    6. 每次上线需要通知相关人员，避免出现沟通问题，原则上需要有上线邮件，特殊情况也必须通知相关人员
    7. 组内每次上线（无论大小）所有人需要知悉，避免出现沟通问题
    8. 小改动上线由开发负责的自己上线，涉及超过3个文件的改动由组内讨论后统一上线

    

    ​	**生产环境做任何操作前，需要对自己要干的事情有一个清楚的认知，同时也要充分做好容错处理以及故障恢复处理的相关准备，避免造成生产事故，每个人应该对生产环境存在敬畏之心。**

## 其它

​	在开发及测试部署等环节，如果对工程中某些地方不明确，需要及时反馈，避免出现因为沟通导致的臆测，继而产生不可预知的问题。

​	每个人的底层逻辑一致时，才能够保证开发中大家能够是一个整体，上边只是对整体工程做一个系统性的说明，有些地方可能还需要在实际开发中多沟通，多注意。